name: Security - SBOM & SCA

on:
  workflow_dispatch:
  push:
    paths:
      - "**/*.py"
      - "requirements*.txt"
      - "reading_list_frontend/package.json"
      - "reading_list_frontend/package-lock.json"
      - ".github/workflows/ci-sbom-sca.yml"
  pull_request:
    paths:
      - "**/*.py"
      - "requirements*.txt"
      - "reading_list_frontend/package.json"
      - "reading_list_frontend/package-lock.json"
      - ".github/workflows/ci-sbom-sca.yml"

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sbom_sca:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure evidence dirs
        run: mkdir -p EVIDENCE/P09

      - name: Generate SBOM for Python dependencies (Syft CycloneDX)
        id: sbom
        run: |
          # Фиксируем версию Syft для воспроизводимости
          docker run --rm -v $PWD:/work -w /work anchore/syft:v0.102.0 \
            packages dir:. -o cyclonedx-json > EVIDENCE/P09/sbom.json
          # Добавляем новую строку в конце для соответствия стандартам
          echo "" >> EVIDENCE/P09/sbom.json

      - name: SCA Scan (Grype)
        run: |
          set -e
          # Фиксируем версию Grype для воспроизводимости
          docker run --rm -v $PWD:/work -w /work anchore/grype:v0.75.0 \
            sbom:/work/EVIDENCE/P09/sbom.json -o json > EVIDENCE/P09/sca_report.json || true
          # Добавляем новую строку в конце для соответствия стандартам
          [ -f EVIDENCE/P09/sca_report.json ] && echo "" >> EVIDENCE/P09/sca_report.json || true

      - name: Apply waivers (filter SCA report)
        run: |
          python - <<'PY'
          import json, sys, pathlib
          from datetime import datetime

          try:
              import yaml
          except ImportError:
              import subprocess; subprocess.check_call([sys.executable, "-m", "pip", "install", "PyYAML"])
              import yaml

          sca = pathlib.Path("EVIDENCE/P09/sca_report.json")
          wa = pathlib.Path("policy/waivers.yml")
          out_filtered = pathlib.Path("EVIDENCE/P09/sca_report.filtered.json")
          out_waived   = pathlib.Path("EVIDENCE/P09/sca_report.waived.json")

          data = json.loads(sca.read_text()) if sca.exists() else {"matches": []}
          waivers = yaml.safe_load(wa.read_text()) if wa.exists() else {}
          waivers = waivers.get("waivers", []) or []

          def waived(m):
              v = m.get("vulnerability", {})
              a = m.get("artifact", {})
              for w in waivers:
                  if w.get("id")==v.get("id") and w.get("package")==a.get("name") and w.get("version")==a.get("version"):
                      exp = w.get("expires_at")
                      if exp:
                          try:
                              if datetime.utcnow() > datetime.fromisoformat(exp):
                                  continue
                          except Exception:
                              pass
                      return True
              return False

          kept, dropped = [], []
          for m in data.get("matches", []):
              (dropped if waived(m) else kept).append(m)

          data["matches"] = kept
          # Добавляем новую строку в конце для соответствия стандартам
          out_filtered.write_text(json.dumps(data, ensure_ascii=False, indent=2) + "\n")
          out_waived.write_text(json.dumps({"waived": dropped}, ensure_ascii=False, indent=2) + "\n")
          print(f"Kept: {len(kept)}, Waived: {len(dropped)}")
          PY

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Generate SCA Summary
        id: summary
        run: |
          echo "# SCA Summary" > EVIDENCE/P09/sca_summary.md
          echo "" >> EVIDENCE/P09/sca_summary.md
          echo "**Generated at:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> EVIDENCE/P09/sca_summary.md
          echo "**Commit:** \`${{ github.sha }}\`" >> EVIDENCE/P09/sca_summary.md
          echo "**Workflow Run:** [\#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> EVIDENCE/P09/sca_summary.md
          echo "**Branch:** \`${{ github.ref_name }}\`" >> EVIDENCE/P09/sca_summary.md
          echo "" >> EVIDENCE/P09/sca_summary.md

          REPORT=EVIDENCE/P09/sca_report.filtered.json
          [ -f "$REPORT" ] || REPORT=EVIDENCE/P09/sca_report.json

          echo "## Vulnerability Summary by Severity" >> EVIDENCE/P09/sca_summary.md
          echo "" >> EVIDENCE/P09/sca_summary.md
          echo "| Severity | Count |" >> EVIDENCE/P09/sca_summary.md
          echo "|----------|-------|" >> EVIDENCE/P09/sca_summary.md
          jq -r '[.matches[].vulnerability.severity] | group_by(.) | map({severity: .[0], count: length}) | .[] | "| \(.severity // "Unknown") | \(.count) |"' \
            "$REPORT" >> EVIDENCE/P09/sca_summary.md 2>/dev/null || echo "| No vulnerabilities found | 0 |" >> EVIDENCE/P09/sca_summary.md

          WAIVED_COUNT=$(jq -r '.waived | length' EVIDENCE/P09/sca_report.waived.json 2>/dev/null || echo "0")
          echo "" >> EVIDENCE/P09/sca_summary.md
          echo "**Waived findings:** ${WAIVED_COUNT}" >> EVIDENCE/P09/sca_summary.md
          echo "" >> EVIDENCE/P09/sca_summary.md

          if [ -f "$REPORT" ]; then
            # Подсчет Critical/High
            CRITICAL_COUNT=$(jq '[.matches[] | select(.vulnerability.severity == "Critical")] | length' "$REPORT" 2>/dev/null || echo "0")
            HIGH_COUNT=$(jq '[.matches[] | select(.vulnerability.severity == "High")] | length' "$REPORT" 2>/dev/null || echo "0")

            if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
              echo "## ⚠️ Critical/High Vulnerabilities" >> EVIDENCE/P09/sca_summary.md
              echo "" >> EVIDENCE/P09/sca_summary.md
              echo "**Critical:** $CRITICAL_COUNT | **High:** $HIGH_COUNT" >> EVIDENCE/P09/sca_summary.md
              echo "" >> EVIDENCE/P09/sca_summary.md
              echo "### Top 10 Critical/High Findings" >> EVIDENCE/P09/sca_summary.md
              echo "" >> EVIDENCE/P09/sca_summary.md

              jq -r '.matches[] | select(.vulnerability.severity == "High" or .vulnerability.severity == "Critical") |
                "#### \(.vulnerability.id)\n- **Package**: `\(.artifact.name)@\(.artifact.version)`\n- **Severity**: \(.vulnerability.severity)\n- **Type**: \(.artifact.type)\n- **Description**: \(.vulnerability.description // "N/A" | split("\n") | .[0])\n- **Fixed in**: \(.vulnerability.fix.versions[]? // "No fix available")\n"' \
                "$REPORT" | head -n 100 >> EVIDENCE/P09/sca_summary.md 2>/dev/null || echo "No High/Critical vulnerabilities found" >> EVIDENCE/P09/sca_summary.md
            else
              echo "## ✅ No Critical/High Vulnerabilities Found" >> EVIDENCE/P09/sca_summary.md
              echo "" >> EVIDENCE/P09/sca_summary.md
            fi

            echo "" >> EVIDENCE/P09/sca_summary.md
            echo "## Next Steps" >> EVIDENCE/P09/sca_summary.md
            echo "" >> EVIDENCE/P09/sca_summary.md
            echo "1. Review Critical/High vulnerabilities above" >> EVIDENCE/P09/sca_summary.md
            echo "2. Update dependencies or create waivers in \`policy/waivers.yml\`" >> EVIDENCE/P09/sca_summary.md
            echo "3. See full report in \`sca_report.json\` for details" >> EVIDENCE/P09/sca_summary.md
          else
            echo "## ⚠️ SCA Report Not Generated" >> EVIDENCE/P09/sca_summary.md
            echo "" >> EVIDENCE/P09/sca_summary.md
            echo "Check workflow logs for errors." >> EVIDENCE/P09/sca_summary.md
          fi

      - name: Upload SBOM/SCA evidence
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: P09_EVIDENCE
          path: |
            EVIDENCE/P09/sbom.json
            EVIDENCE/P09/sca_report.json
            EVIDENCE/P09/sca_report.filtered.json
            EVIDENCE/P09/sca_report.waived.json
            EVIDENCE/P09/sca_summary.md
          retention-days: 90

  commit-evidence:
    needs: sbom_sca
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: P09_EVIDENCE
          path: EVIDENCE/P09

      - name: Commit evidence
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add EVIDENCE/P09/
          if ! git diff --staged --quiet; then
            git commit -m "chore: update SBOM & SCA evidence [skip ci]"
            git push
          else
            echo "No changes to commit"
          fi
