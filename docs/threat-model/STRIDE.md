# STRIDE — Угрозы и контроли

**(приоритет см. в RISKS по RiskID)**

| Поток/Элемент       | Угроза (S/T/R/I/D/E) | Описание угрозы                                                                 | Контроль                                                                 | Ссылка на NFR        | Проверка / Артефакт                                 |
|---------------------|----------------------|----------------------------------------------------------------------------------|--------------------------------------------------------------------------|----------------------|------------------------------------------------------|
| F1: /auth/register  | S (Spoofing)         | Массовая регистрация ботов/фейков (**R8**)                                       | Ограничение частоты (rate-limit), проверка email                         | NFR-01               | Unit-тесты регистрации, отрицательные сценарии       |
| F2: /auth/login     | T (Tampering)        | Брутфорс логина, подбор пароля (**R1**)                                          | Rate-limit на логин; проверка `device_id`                                | NFR-06               | Контракт-тесты auth, поведенческие тесты ошибок      |
| F2: /auth/login     | I (Information)      | Избыточные сообщения об ошибках (user enumeration) (**R5**)                      | Унификация ошибок (всегда 401/403, без деталей)                          | NFR-06               | Контракт-тесты API                                   |
| F3: create user     | I (Information)      | Недостаточная стойкость хранения паролей (**R9**)                                | Хранение только bcrypt-хэшей (не plaintext)                              | NFR-01               | Unit-тест `hash_password`                            |
| F3: create user     | E (Elevation)        | Повышение привилегий (роль `admin` при регистрации) (**R10**)                    | Роль по умолчанию — `user`; запрет явного назначения `admin`             | NFR-05               | Юнит-тесты модели/сервиса пользователей              |
| F4: persist refresh | T (Tampering)        | Reuse/подмена refresh-токена (replay) (**R2**)                                   | Проверка `jti`, `device_id`, флаг `revoked`                               | NFR-04               | Тесты `revoke_refresh_by_jti/for_device`             |
| F5: entries (GET)   | D (Denial)           | DoS/перегрузка `/entries` (**R7**)                                               | Пагинация; ограничение `limit ≤ 200`                                     | NFR-09               | Нагрузочный тест; проверка лимитов                   |
| F5: entries (GET)   | I (Information)      | Доступ к чужим записям (IDOR) (**R4**)                                           | Фильтрация по `owner_id`; проверка прав                                  | NFR-05, NFR-08       | Интеграционные тесты доступа                         |
| F6: update entry    | T (Tampering)        | Обновление чужих записей (**R4**)                                                | Проверка совпадения `owner_id`                                           | NFR-05               | Юнит/интеграционные тесты CRUD                       |
| F7: refresh         | S (Spoofing)         | Использование чужого refresh + `device_id` (**R2**)                              | Сопоставление `jti` и `device_id`; проверка статуса refresh              | NFR-04               | Тесты endpoint `/auth/refresh`                       |
| F7b: rotate refresh | R (Repudiation)      | Нет трассировки ротации refresh (**R2**)                                         | Логирование связи `old_jti → new_jti`; аудиторский след                  | NFR-04               | Логи/аудит; unit/интеграционные тесты                |
| F8: logout          | T (Tampering)        | Неполный logout (refresh/access не в blacklist, девайс не отозван) (**R11**)     | Отзыв refresh по `device_id`; запись в `revoked_tokens` для обоих jti     | NFR-04               | Тесты logout/blacklist                               |
| F9: load secrets    | I (Information)      | Утечка секретов (JWT_SECRET/ISSUER) (**R3**)                                     | `.env`/CI-secrets; pre-commit/CI-проверка утечек                          | NFR-07               | `detect-secrets`, `dotenv-linter`, code review       |
| F1/F2/F5/F10: TLS   | I (Information)      | Нет TLS на периметре (MITM/сниффинг) (**R6**)                                    | Принудительный HTTPS (TLS ≥ 1.2), редирект с HTTP                        | NFR-09               | Проверка деплоя/TLS (curl, security headers)         |
| F10: /admin         | E (Elevation)        | Доступ к админке без нужной роли (**R10**)                                       | RBAC: проверка роли `admin`                                               | NFR-05               | Тесты авторизации на `/api/v1/admin`                 |
| F5: entries (responses) | I (Information)      | Избыточные/чувствительные поля в JSON-ответах (**R12**) | Явные pydantic-схемы; исключение лишних полей; ревью моделей | NFR-08 | Контракт-тесты и snapshot-проверки JSON |
