# ADR-003: RBAC и доступ только к своим данным (owner-based)
Дата: 2025-10-15
Статус: Accepted

## Context
В системе есть роли `user` и `admin`. Нужно обеспечить, что обычный пользователь видит/меняет только свои записи (`owner_id`), а администратор — имеет расширенный доступ (`/api/v1/admin`). Это закрывает IDOR и риск эскалации привилегий.

## Decision
- В access-токене передаётся claim `role`.
- Мидлвара аутентификации читает токен и помещает в `request.state.user` компактные данные: `id`, `role`, `claims`.
- Эндпоинт `/api/v1/admin` проверяет роль `admin` и отдаёт список пользователей (`app/routers/admin.py`).
- Операции над `entries` на уровне сервисов фильтруются по `owner_id` (см. `services/entries.py`):
  - user получает только свои записи;
  - обновление/удаление возможно только владельцем;
  - админские листинги доступны по отдельному пути/контролю.
- JSON-схемы исключают лишние поля в ответах (NFR-08), предотвращая утечки.

## Consequences
- Плюсы: снижение риска R4 (IDOR) и R10 (эскалация привилегий), прозрачная модель доступа.
- Минусы: необходимость аккуратно поддерживать фильтры по owner_id и проверку роли во всех новых ручках.
- DX: просто расширяется при добавлении новых ролей через единый источник `role` в токене.

## Alternatives
- Проверка доступа только на уровне БД (Row-Level Security): надёжно, но усложняет схему и миграции; для учебного проекта избыточно.
- ACL на уровне каждой ручки без общего middleware: гибко, но повышает риск пропустить проверку.
- Полностью централизованные policy (OPA/oso): мощно, но добавляет новый сервис и сложность.

## Security impact
- Снижение вероятности R4/R10/R12. Индикаторы: отсутствие доступа к чужим данным в тестах/логах; 403/404 для чужих ресурсов; проверка `owner_id` на всех CRUD путях.
- Связь с P03/P04: NFR-05/NFR-08; STRIDE R4/R10/R12.

## Rollout plan / DoD
- DoD: все тесты на `entries`/`admin` зелёные; проверка роли в `app/routers/admin.py`; фильтрация по `owner_id` реализована в сервисах.
- Rollout: при добавлении новых ручек — шаблон проверок (middlewares + dependency), ревью/чек-лист на owner-фильтр и роль.

## Links
- NFR-05 (Авторизация по ролям), NFR-08 (Приватность моделей)
- DFD Flows: F5 (entries with Bearer), F6 (update entries), F10 (admin), F10b (list users)
- STRIDE/RISKS: R4, R10, R12
- Код: `app/middleware.py`, `app/routers/admin.py`, `services/entries.py`, `domain/schemas.py`
- Тесты: `tests/test_entries.py` (own-only, admin filters), `tests/test_admin.py`
