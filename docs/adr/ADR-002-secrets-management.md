# ADR-002: Управление секретами (JWT_SECRET/ISSUER) и ротация
Дата: 2025-10-15
Статус: Accepted

## Context
Секреты (JWT_SECRET, JWT_ISSUER и прочие) не должны храниться в коде/репозитории. Нужны правила загрузки из окружения/.env, защита от утечек, а также подход к ротации ключей без даунтайма.

## Decision
- Источник секретов: переменные окружения и `.env` (через `pydantic_settings.BaseSettings` в `config.py`).
- Запрет секретов в коде/логах/конфиг-файлах репозитория; проведение проверок на утечки на этапе CI (например, `detect-secrets`/`dotenv-linter`).
- Формат JWT: HS256 с секретом `settings.JWT_SECRET`; `settings.JWT_ISSUER` обязателен и верифицируется при декодировании.
- Ротация секретов:
  - Плановая: деплой с новым `JWT_SECRET` и включённым «переходным окном» — валидация допускает текущий и предыдущий ключ на краткий период (в данном проекте — задел на будущее; сейчас используется один ключ, расширение возможно через конфиг).
  - Аварийная: немедленная замена ключа; все активные токены станут недействительны, пользователям потребуется перелогин.
- Логи: исключаем вывод значений секретов и полных токенов; при ошибках оставляем только безопасные идентификаторы (например, `jti`, `correlation_id`).

## Consequences
- Плюсы: снижается риск R3 (утечки секретов), проще аудит и соответствие требованиям.
- Минусы: сложность при ротации ключей для активных токенов; требуется дисциплина DevOps и CI-проверки.
- DX/стоимость: низкие; внедрение линтеров для секретов в CI.

## Alternatives
- Хранить секреты в коде/конфигах: быстро, но высокий риск утечек и регресса.
- Секреты в менеджере (Vault/SM)/KMS: максимально безопасно, но требует инфраструктуры; для учебного/локального окружения избыточно.
- Мульти-ключ JWT (kid, key set): гибкая ротация без даунтайма; усложняет конфигурацию, добавим по мере роста.

## Security impact
- Уменьшение вероятности R3. Индикаторы: отсутствие секретов в истории/диффах; успешная валидация `iss`/подписи; отсутствие токенов в логах.
- Связь с P03/P04: NFR-07/NFR-09; STRIDE R3.

## Rollout plan / DoD
- DoD: `config.py` читает значения из окружения; локально — `.env` добавлен в `.gitignore`; секреты не логируются.
- Rollout: для CI/PR позже добавить pre-commit/Actions проверки (`detect-secrets`, `dotenv-linter`), как указано в ADR; сейчас — документированная политика.

## Links
- NFR-07 (Секреты вне кода), NFR-09 (TLS perimetr)
- DFD Flows: F9 (load secrets)
- STRIDE/RISKS: R3
- Код: `config.py`, `adapters/security.py`
- Тесты: интеграционные тесты auth/login/refresh (`tests/test_login.py`, `tests/test_refresh.py`) подтверждают корректную подпись/issuer.
