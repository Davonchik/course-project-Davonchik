# P10 - SAST & Secrets Evidence

Этот каталог содержит артефакты статического анализа кода (SAST) и сканирования секретов.

## Структура

- `semgrep.sarif` — Отчёт SAST в формате SARIF (Static Analysis Results Interchange Format)
  - Генерируется инструментом Semgrep
  - Использует профиль `p/ci` (быстрые проверки для CI)
  - Включает кастомные правила из `security/semgrep/rules.yml`
  - Содержит findings с severity (ERROR/WARNING/INFO) и привязкой к коду

- `gitleaks.json` — Отчёт по обнаруженным секретам
  - Генерируется инструментом Gitleaks
  - Использует конфигурацию из `security/.gitleaks.toml`
  - Сканирует текущую рабочую копию репозитория (без истории коммитов)
  - Содержит список потенциальных секретов с путями и контекстом

- `sast_summary.md` — (опционально) Краткая сводка по findings
  - Статистика по severity из Semgrep
  - Количество обнаруженных секретов
  - Ключевые findings и план действий

## Конфигурация

### Semgrep

- **Профиль**: `p/ci` (базовые проверки для CI)
- **Кастомные правила**: `security/semgrep/rules.yml`
  - Проверка на слабые JWT-секреты
  - Проверка на дефолтные пароли БД
  - Проверка на широкие exception handlers
  - Проверка на небезопасное декодирование JWT

### Gitleaks

- **Конфигурация**: `security/.gitleaks.toml`
- **Allowlist**: Исключает известные false positives:
  - Dev-секреты в `config.py` (тестовые значения)
  - Артефакты в `EVIDENCE/`
  - Служебные директории (`__pycache__`, `node_modules`)

## Использование

### Для DS-раздела итогового отчёта

Эти артефакты используются для демонстрации:
- **DS1** — SAST и сканирование секретов в контексте проекта
- Трассируемость проблем безопасности в коде
- Процесс триажа findings (исправление / игнор / backlog)

### Связь с другими практиками

- **P08 (CI/CD)**: Workflow `ci-sast-secrets.yml` интегрирован в общий CI/CD процесс
- **P09 (SBOM/SCA)**: Дополняет анализ зависимостей анализом собственного кода
- **Threat Model**: Findings могут быть связаны с рисками из `docs/threat-model/RISKS.md`

## Workflow

Артефакты автоматически генерируются при:
- Изменении Python файлов
- Изменении конфигураций Semgrep/Gitleaks
- Изменении самого workflow файла
- Ручном запуске через `workflow_dispatch`
- Создании/обновлении Pull Request

Workflow: `.github/workflows/ci-sast-secrets.yml`

### Jobs

- `sast_secrets` — запускает Semgrep и Gitleaks, сохраняет артефакты
- `commit-evidence` — коммитит артефакты обратно в ветку (только при `workflow_dispatch` или `push` на не-main ветки)

## Триаж findings

### Semgrep

Findings классифицируются по severity:
- **ERROR** — критические проблемы, требуют немедленного исправления
- **WARNING** — потенциальные проблемы, рекомендуется исправить
- **INFO** — информационные замечания, можно отложить

### Gitleaks

- **Реальные секреты** — должны быть немедленно удалены из кода и ротированы
- **False positives** — добавляются в allowlist в `security/.gitleaks.toml` с комментарием

## Воспроизводимость

- Инструменты запускаются через Docker (фиксированные образы)
- Каждый прогон привязан к конкретному коммиту через `github.sha`
- Артефакты доступны в GitHub Actions на 90 дней
- При ручном запуске артефакты автоматически коммитятся обратно в ветку
